#!/usr/bin/env node
// Generated by LiveScript 1.4.0
(function(){
  var fetch, co, cfy, jimp, icojs, cheerio, favicon_patterns_href, favicon_patterns_content, fetchFavicons, fetch_favicon, toBuffer, get_canonical_url, get_canonical_domain, url_to_domain, domain_to_url, make_async, does_file_exist, async_filter, get_favicon_data_for_url, get_png_data_for_url, get_favicon_data_for_domain;
  fetch = require('node-fetch');
  co = require('co');
  cfy = require('cfy');
  jimp = require('jimp');
  icojs = require('icojs');
  cheerio = require('cheerio');
  favicon_patterns_href = ['link[rel=apple-touch-icon-precomposed]', 'link[rel=apple-touch-icon]', 'link[rel="shortcut icon"]', 'link[rel=icon]'];
  favicon_patterns_content = ['meta[name=msapplication-TileImage]', 'meta[name=twitter\\:image]', 'meta[property=og\\:image]'];
  fetchFavicons = cfy(function*(domain){
    var response, text, $, output, i$, ref$, len$, pattern, j$, ref1$, len1$, x, url;
    domain = domain_to_url(domain);
    response = (yield fetch(domain));
    text = (yield response.text());
    $ = cheerio.load(text);
    output = [];
    for (i$ = 0, len$ = (ref$ = favicon_patterns_href).length; i$ < len$; ++i$) {
      pattern = ref$[i$];
      for (j$ = 0, len1$ = (ref1$ = $(pattern)).length; j$ < len1$; ++j$) {
        x = ref1$[j$];
        url = $(x).attr('href');
        if (url != null) {
          output.push(url);
        }
      }
    }
    for (i$ = 0, len$ = (ref$ = favicon_patterns_content).length; i$ < len$; ++i$) {
      pattern = ref$[i$];
      for (j$ = 0, len1$ = (ref1$ = $(pattern)).length; j$ < len1$; ++j$) {
        x = ref1$[j$];
        url = $(x).attr('content');
        if (url != null) {
          output.push(url);
        }
      }
    }
    output.push('/favicon.ico');
    output = output.map(function(x){
      var domain_without_slash;
      if (x.startsWith('http://') || x.startsWith('https://')) {
        return x;
      }
      domain_without_slash = domain;
      if (domain.endsWith('/') && x.startsWith('/')) {
        domain_without_slash = domain.substr(0, domain.length - 1);
      }
      return domain_without_slash + x;
    });
    output = output.map(function(it){
      return {
        href: it,
        name: 'favicon.ico'
      };
    });
    return output;
  });
  fetch_favicon = {
    fetchFavicons: fetchFavicons
  };
  toBuffer = function(ab){
    var buf, view, i$, to$, i;
    buf = new Buffer(ab.byteLength);
    view = new Uint8Array(ab);
    for (i$ = 0, to$ = buf.length; i$ < to$; ++i$) {
      i = i$;
      buf[i] = view[i];
    }
    return buf;
  };
  get_canonical_url = cfy(function*(url){
    var response, e;
    try {
      response = (yield fetch(url));
      return response.url;
    } catch (e$) {
      e = e$;
      return null;
    }
  });
  get_canonical_domain = cfy(function*(domain){
    var url, canonical_url;
    url = domain_to_url(domain);
    canonical_url = (yield get_canonical_url(url));
    if (canonical_url != null) {
      return url_to_domain(canonical_url);
    }
    return null;
  });
  url_to_domain = function(url){
    var domain;
    if (url.indexOf("://") > -1) {
      domain = url.split('/')[2];
    } else {
      domain = url.split('/')[0];
    }
    domain = domain.split(':')[0];
    return domain;
  };
  domain_to_url = function(domain){
    return "http://" + url_to_domain(domain) + '/';
  };
  make_async = function(sync_func){
    return function(x){
      return Promise.resolve(sync_func(x));
    };
  };
  does_file_exist = cfy(function*(url){
    var request, e;
    if (typeof url !== 'string' && typeof url.href === 'string') {
      url = url.href;
    }
    try {
      request = (yield fetch(url));
      if (!request.ok) {
        return false;
      }
      (yield request.text());
      return true;
    } catch (e$) {
      e = e$;
      return false;
    }
  });
  async_filter = cfy(function*(list, async_function){
    var output, i$, len$, x;
    output = [];
    for (i$ = 0, len$ = list.length; i$ < len$; ++i$) {
      x = list[i$];
      if ((yield async_function(x))) {
        output.push(x);
      }
    }
    return output;
  });
  get_favicon_data_for_url = cfy(function*(domain){
    var favicon_path, all_favicon_paths, filter_functions, i$, len$, filter_function, new_all_favicon_paths, favicon_response, favicon_buffer, favicon_ico_parsed, favicon_png_buffer;
    if (domain.endsWith('.ico')) {
      favicon_path = domain;
    } else {
      if (!domain.startsWith('http://') || domain.startsWith('https://')) {
        domain = 'http://' + domain;
      }
      all_favicon_paths = (yield fetch_favicon.fetchFavicons(domain));
      filter_functions = [does_file_exist];
      filter_functions = filter_functions.concat([
        function(it){
          return it.name === 'favicon.ico';
        }, function(it){
          return it.href.endsWith('favicon.ico');
        }, function(it){
          return it.href.startsWith('favicon.ico');
        }, function(it){
          return it.href.includes('favicon.ico');
        }, function(it){
          return it.href.endsWith('.ico');
        }, function(it){
          return it.href.includes('favicon');
        }
      ].map(make_async));
      for (i$ = 0, len$ = filter_functions.length; i$ < len$; ++i$) {
        filter_function = filter_functions[i$];
        new_all_favicon_paths = (yield async_filter(all_favicon_paths, filter_function));
        if (new_all_favicon_paths.length > 0) {
          all_favicon_paths = new_all_favicon_paths;
        }
      }
      favicon_path = (yield get_canonical_url(all_favicon_paths[0].href));
    }
    favicon_response = (yield fetch(favicon_path));
    favicon_buffer = new Uint8Array((yield favicon_response.buffer())).buffer;
    favicon_ico_parsed = (yield icojs.parse(favicon_buffer));
    favicon_png_buffer = toBuffer(favicon_ico_parsed[0].buffer);
    return 'data:image/png;base64,' + favicon_png_buffer.toString('base64');
  });
  get_png_data_for_url = cfy(function*(domain){
    var favicon_path, all_favicon_paths, filter_functions, i$, len$, filter_function, new_all_favicon_paths, favicon_data;
    if (domain.endsWith('.png') || domain.endsWith('.svg')) {
      favicon_path = domain;
    } else {
      if (!domain.startsWith('http://') || domain.startsWith('https://')) {
        domain = 'http://' + domain;
      }
      all_favicon_paths = (yield fetch_favicon.fetchFavicons(domain));
      filter_functions = [does_file_exist];
      filter_functions = filter_functions.concat([
        function(it){
          return it.href.endsWith('.png');
        }, function(it){
          return it.href.includes('.png');
        }
      ].map(make_async));
      for (i$ = 0, len$ = filter_functions.length; i$ < len$; ++i$) {
        filter_function = filter_functions[i$];
        new_all_favicon_paths = (yield async_filter(all_favicon_paths, filter_function));
        if (new_all_favicon_paths.length > 0) {
          all_favicon_paths = new_all_favicon_paths;
        }
      }
      favicon_path = (yield get_canonical_url(all_favicon_paths[0].href));
    }
    favicon_data = (yield jimp.read(favicon_path));
    favicon_data.resize(40, 40);
    return (yield function(it){
      return favicon_data.getBase64('image/png', it);
    });
  });
  get_favicon_data_for_domain = cfy(function*(domain){
    var e, canonical_domain;
    try {
      return (yield get_png_data_for_url(domain));
    } catch (e$) {
      e = e$;
    }
    canonical_domain = (yield get_canonical_domain(domain));
    try {
      return (yield get_png_data_for_url(canonical_domain));
    } catch (e$) {
      e = e$;
    }
    try {
      return (yield get_favicon_data_for_url(domain));
    } catch (e$) {
      e = e$;
    }
    return (yield get_favicon_data_for_url(canonical_domain));
  });
  co(function*(){
    var domain, favicon_data;
    domain = process.argv[2];
    if (domain == null) {
      console.log('please specify a domain');
      return;
    }
    if (domain.startsWith('/')) {
      favicon_data = (yield jimp.read(domain));
      favicon_data.resize(40, 40);
      console.log((yield function(it){
        return favicon_data.getBase64('image/png', it);
      }));
      return;
    }
    favicon_data = (yield get_favicon_data_for_domain(domain));
    return console.log(favicon_data);
  });
}).call(this);
