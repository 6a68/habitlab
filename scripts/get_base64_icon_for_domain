#!/usr/bin/env node
// Generated by LiveScript 1.4.0
(function(){
  var fetch, fetch_favicon, icojs, co, cfy, toBuffer, get_canonical_url, get_canonical_domain, url_to_domain, domain_to_url, make_async, does_file_exist, async_filter, get_favicon_data_for_url, get_favicon_data_for_domain;
  fetch = require('node-fetch');
  fetch_favicon = require('fetch-favicon');
  icojs = require('icojs');
  co = require('co');
  cfy = require('cfy');
  toBuffer = function(ab){
    var buf, view, i$, to$, i;
    buf = new Buffer(ab.byteLength);
    view = new Uint8Array(ab);
    for (i$ = 0, to$ = buf.length; i$ < to$; ++i$) {
      i = i$;
      buf[i] = view[i];
    }
    return buf;
  };
  get_canonical_url = cfy(function*(url){
    var response, e;
    try {
      response = (yield fetch(url));
      return response.url;
    } catch (e$) {
      e = e$;
      return null;
    }
  });
  get_canonical_domain = cfy(function*(domain){
    var url, canonical_url;
    url = domain_to_url(domain);
    canonical_url = (yield get_canonical_url(url));
    if (canonical_url != null) {
      return url_to_domain(canonical_url);
    }
    return null;
  });
  url_to_domain = function(url){
    var domain;
    if (url.indexOf("://") > -1) {
      domain = url.split('/')[2];
    } else {
      domain = url.split('/')[0];
    }
    domain = domain.split(':')[0];
    return domain;
  };
  domain_to_url = function(domain){
    return "http://" + url_to_domain(domain) + '/';
  };
  make_async = function(sync_func){
    return function(x){
      return Promise.resolve(sync_func(x));
    };
  };
  does_file_exist = cfy(function*(url){
    var request, e;
    if (typeof url !== 'string' && typeof url.href === 'string') {
      url = url.href;
    }
    try {
      request = (yield fetch(url));
      if (!request.ok) {
        return false;
      }
      (yield request.text());
      return true;
    } catch (e$) {
      e = e$;
      return false;
    }
  });
  async_filter = cfy(function*(list, async_function){
    var output, i$, len$, x;
    output = [];
    for (i$ = 0, len$ = list.length; i$ < len$; ++i$) {
      x = list[i$];
      if ((yield async_function(x))) {
        output.push(x);
      }
    }
    return output;
  });
  get_favicon_data_for_url = cfy(function*(domain){
    var favicon_path, all_favicon_paths, filter_functions, i$, len$, filter_function, new_all_favicon_paths, favicon_response, favicon_buffer, favicon_ico_parsed, favicon_png_buffer;
    if (domain.endsWith('.ico')) {
      favicon_path = domain;
    } else {
      if (!domain.startsWith('http://') || domain.startsWith('https://')) {
        domain = 'http://' + domain;
      }
      all_favicon_paths = (yield fetch_favicon.fetchFavicons(domain));
      filter_functions = [does_file_exist];
      filter_functions = filter_functions.concat([
        function(it){
          return it.name === 'favicon.ico';
        }, function(it){
          return it.href.endsWith('favicon.ico');
        }, function(it){
          return it.href.includes();
        }, function(it){
          return it.href.endsWith('.ico');
        }, function(it){
          return it.href.includes('favicon');
        }
      ].map(make_async));
      for (i$ = 0, len$ = filter_functions.length; i$ < len$; ++i$) {
        filter_function = filter_functions[i$];
        new_all_favicon_paths = (yield async_filter(all_favicon_paths, filter_function));
        if (new_all_favicon_paths.length > 0) {
          all_favicon_paths = new_all_favicon_paths;
        }
      }
      favicon_path = (yield get_canonical_url(all_favicon_paths[0].href));
    }
    favicon_response = (yield fetch(favicon_path));
    favicon_buffer = new Uint8Array((yield favicon_response.buffer())).buffer;
    favicon_ico_parsed = (yield icojs.parse(favicon_buffer));
    favicon_png_buffer = toBuffer(favicon_ico_parsed[0].buffer);
    return 'data:image/png;base64,' + favicon_png_buffer.toString('base64');
  });
  get_favicon_data_for_domain = cfy(function*(domain){
    var e;
    try {
      return (yield get_favicon_data_for_url(domain));
    } catch (e$) {
      e = e$;
    }
    domain = (yield get_canonical_domain(domain));
    return (yield get_favicon_data_for_url(domain));
  });
  co(function*(){
    var domain, favicon_data;
    domain = process.argv[2];
    if (domain == null) {
      console.log('please specify a domain');
      return;
    }
    favicon_data = (yield get_favicon_data_for_domain(domain));
    return console.log(favicon_data);
  });
}).call(this);
